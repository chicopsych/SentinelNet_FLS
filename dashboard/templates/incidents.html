{% extends "base.html" %}

{% block title %}Incidentes — SentinelNet{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h4 mb-0">
    <i class="bi bi-exclamation-triangle me-2 text-danger"></i>Incidentes
  </h1>
</div>

<!-- ── Filtros ─────────────────────────────────────────────────────────── -->
<form method="get" class="row g-2 mb-4 align-items-end">
  <div class="col-sm-3">
    <label class="form-label small text-muted mb-1">Cliente</label>
    <input
      type="text"
      name="customer"
      class="form-control form-control-sm"
      placeholder="ex: cliente-a"
      value="{{ filters.customer or '' }}"
    />
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Dispositivo</label>
    <input
      type="text"
      name="device_id"
      class="form-control form-control-sm"
      placeholder="ex: borda-01"
      value="{{ filters.device_id or '' }}"
    />
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Vendor</label>
    <input
      type="text"
      name="vendor"
      class="form-control form-control-sm"
      placeholder="ex: mikrotik"
      title="Filtrar por vendor"
      value="{{ filters.vendor or '' }}"
    />
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Severidade</label>
    <select name="severity" class="form-select form-select-sm" title="Filtrar por Severidade">
      <option value="">Todas</option>
      {% for sev in severity_options %}
      <option value="{{ sev }}" {% if filters.severity == sev %}selected{% endif %}>{{ sev }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Severidade mínima</label>
    <select name="min_severity" class="form-select form-select-sm" title="Filtrar por severidade mínima">
      <option value="">Sem mínimo</option>
      <option value="INFO" {% if filters.min_severity == 'INFO' %}selected{% endif %}>INFO</option>
      <option value="LOW" {% if filters.min_severity == 'LOW' %}selected{% endif %}>LOW</option>
      <option value="WARNING" {% if filters.min_severity == 'WARNING' %}selected{% endif %}>WARNING</option>
      <option value="MEDIUM" {% if filters.min_severity == 'MEDIUM' %}selected{% endif %}>MEDIUM</option>
      <option value="HIGH" {% if filters.min_severity == 'HIGH' %}selected{% endif %}>HIGH</option>
      <option value="CRITICAL" {% if filters.min_severity == 'CRITICAL' %}selected{% endif %}>CRITICAL</option>
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Status</label>
    <select name="status" class="form-select form-select-sm" title="Filtrar por Status">
      <option value="">Todos</option>
      {% for item in status_options %}
      <option value="{{ item.value }}" {% if filters.status == item.value %}selected{% endif %}>{{ item.label }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Início</label>
    <input
      type="date"
      name="start_date"
      class="form-control form-control-sm"
      title="Data inicial"
      value="{{ filters.start_date or '' }}"
    />
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Fim</label>
    <input
      type="date"
      name="end_date"
      class="form-control form-control-sm"
      title="Data final"
      value="{{ filters.end_date or '' }}"
    />
  </div>
  <div class="col-sm-2">
    <label class="form-label small text-muted mb-1">Ordenação</label>
    <select name="sort" class="form-select form-select-sm" title="Ordenar incidentes">
      <option value="newest" {% if (filters.sort or 'newest') == 'newest' %}selected{% endif %}>Mais recentes</option>
      <option value="oldest" {% if filters.sort == 'oldest' %}selected{% endif %}>Mais antigos</option>
      <option value="severity_desc" {% if filters.sort == 'severity_desc' %}selected{% endif %}>Severidade (maior)</option>
      <option value="severity_asc" {% if filters.sort == 'severity_asc' %}selected{% endif %}>Severidade (menor)</option>
    </select>
  </div>
  <div class="col-sm-auto">
    <button type="submit" class="btn btn-sm btn-primary">
      <i class="bi bi-funnel me-1"></i>Filtrar
    </button>
    <a href="{{ url_for('incidents.list_incidents') }}" class="btn btn-sm btn-outline-secondary ms-1">
      Limpar
    </a>
  </div>
</form>

{% set has_active_filters =
  (filters.customer or filters.device_id or filters.vendor or filters.severity or
  filters.min_severity or filters.status or filters.start_date or filters.end_date or
  ((filters.sort or 'newest') != 'newest'))
%}

{% set status_chip_labels = {
  'new': 'Novo',
  'novo': 'Novo',
  'em_analise': 'Em análise',
  'aprovado': 'Aprovado',
  'executado': 'Executado',
  'validado': 'Validado',
  'falhou': 'Falhou',
  'revertido': 'Revertido'
} %}

{% set sort_chip_labels = {
  'newest': 'Mais recentes',
  'oldest': 'Mais antigos',
  'severity_desc': 'Severidade (maior)',
  'severity_asc': 'Severidade (menor)'
} %}

{% if has_active_filters %}
<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
  <span class="small text-muted">Filtros ativos:</span>

  {% if filters.customer %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer='', device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}"
    title="Remover filtro de cliente">Cliente: {{ filters.customer }} ×</a>
  {% endif %}

  {% if filters.device_id %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id='', vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}"
    title="Remover filtro de dispositivo">Dispositivo: {{ filters.device_id }} ×</a>
  {% endif %}

  {% if filters.vendor %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor='', severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}"
    title="Remover filtro de vendor">Vendor: {{ filters.vendor }} ×</a>
  {% endif %}

  {% if filters.severity %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity='', min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}"
    title="Remover filtro de severidade">Severidade: {{ filters.severity }} ×</a>
  {% endif %}

  {% if filters.min_severity %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity='', status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}"
    title="Remover filtro de severidade mínima">Sev. mínima: {{ filters.min_severity }} ×</a>
  {% endif %}

  {% if filters.status %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status='', start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}"
      title="Remover filtro de status">Status: {{ status_chip_labels.get(filters.status, filters.status) }} ×</a>
  {% endif %}

  {% if filters.start_date %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date='', end_date=base_query.end_date, sort=base_query.sort) }}"
    title="Remover data inicial">Início: {{ filters.start_date }} ×</a>
  {% endif %}

  {% if filters.end_date %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date='', sort=base_query.sort) }}"
    title="Remover data final">Fim: {{ filters.end_date }} ×</a>
  {% endif %}

  {% if (filters.sort or 'newest') != 'newest' %}
  <a class="badge rounded-pill text-bg-light text-decoration-none"
    href="{{ url_for('incidents.list_incidents', page=1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort='newest') }}"
      title="Remover ordenação customizada">Ordenação: {{ sort_chip_labels.get(filters.sort, filters.sort) }} ×</a>
  {% endif %}

  <a class="small text-decoration-none ms-1" href="{{ url_for('incidents.list_incidents') }}">Limpar tudo</a>
</div>
{% endif %}

<!-- ── Tabela ──────────────────────────────────────────────────────────── -->
{% if incidents %}
<div class="table-responsive">
  <table class="table table-hover align-middle small">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Dispositivo</th>
        <th>Cliente</th>
        <th>Vendor</th>
        <th>Severidade</th>
        <th>Tipo</th>
        <th>Status</th>
        <th>Detectado em</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for inc in incidents %}
      <tr>
        <td class="font-monospace text-muted">{{ inc.id }}</td>
        <td>{{ inc.device }}</td>
        <td>{{ inc.customer }}</td>
        <td>{{ inc.vendor }}</td>
        <td>
          {% set severity = inc.severity %}
          {% include "partials/_severity_badge.html" %}
        </td>
        <td>{{ inc.type }}</td>
        <td>
          {% set status = inc.status %}
          {% include "partials/_status_badge.html" %}
        </td>
        <td class="text-muted">{{ inc.detected_at }}</td>
        <td>
          <a href="{{ url_for('incidents.get_incident', incident_id=inc.id) }}"
             class="btn btn-sm btn-outline-primary"
             title="Visualizar incidente"
             aria-label="Ver detalhes do incidente {{ inc.id }}">
            <i class="bi bi-eye" aria-hidden="true"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Paginação simples -->
<nav aria-label="Navegação de páginas de incidentes">
  <ul class="pagination pagination-sm justify-content-end">
    {% if has_prev %}
    <li class="page-item"><a class="page-link" href="{{ url_for('incidents.list_incidents', page=page - 1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}" aria-label="Página anterior">Anterior</a></li>
    {% endif %}
    <li class="page-item active" aria-current="page"><span class="page-link">{{ page }}</span></li>
    {% if has_next %}
    <li class="page-item"><a class="page-link" href="{{ url_for('incidents.list_incidents', page=page + 1, customer=base_query.customer, device_id=base_query.device_id, vendor=base_query.vendor, severity=base_query.severity, min_severity=base_query.min_severity, status=base_query.status, start_date=base_query.start_date, end_date=base_query.end_date, sort=base_query.sort) }}">Próxima</a></li>
    {% endif %}
  </ul>
</nav>

{% else %}
{% set message = "Nenhum incidente encontrado para os filtros selecionados." %}
{% set icon = "inbox" %}
{% set icon_margin_bottom = 3 %}
{% include "partials/_empty_state.html" %}
{% endif %}

{% endblock %}
