{% extends "base.html" %}

{% block title %}Dispositivos — SentinelNet{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <h1 class="h4 mb-0">
    <i class="bi bi-router me-2 text-primary"></i>Dispositivos Monitorados
    <span class="badge bg-secondary ms-2">{{ total }}</span>
  </h1>

  <div class="d-flex gap-2">
    <a href="{{ url_for('devices.onboard_device') }}" class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle me-1"></i>Novo Dispositivo
    </a>
    <a href="{{ url_for('devices.discover_devices') }}" class="btn btn-sm btn-outline-success">
      <i class="bi bi-radar me-1"></i>Discovery via Nmap
    </a>
  </div>

  <!-- Filtros -->
  <form method="get" class="d-flex gap-2 flex-wrap">
    <input
      type="text" name="customer" value="{{ request.args.get('customer', '') }}"
      class="form-control form-control-sm sn-filter-customer"
      placeholder="Filtrar por cliente"
    />
    <input
      type="text" name="vendor" value="{{ request.args.get('vendor', '') }}"
      class="form-control form-control-sm sn-filter-vendor"
      placeholder="Filtrar por vendor"
    />
    <button type="submit" class="btn btn-sm btn-outline-primary">
      <i class="bi bi-funnel me-1"></i>Filtrar
    </button>
    {% if request.args.get('customer') or request.args.get('vendor') %}
    <a href="{{ url_for('devices.list_devices') }}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-x-circle me-1"></i>Limpar
    </a>
    {% endif %}
  </form>
</div>

{% if not devices %}
<!-- Empty state -->
<div class="card border-0 shadow-sm">
  <div class="card-body">
    {% set message = "Nenhum dispositivo encontrado com os filtros aplicados." %}
    {% set icon = "inbox" %}
    {% include "partials/_empty_state.html" %}
  </div>
</div>

{% else %}
<!-- Tabela de dispositivos -->
<div class="card border-0 shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Status</th>
            <th>Dispositivo</th>
            <th>Cliente</th>
            <th>Vendor</th>
            <th class="text-center">Incidentes Abertos</th>
            <th>Maior Severidade</th>
            <th>Ultima Ocorrencia</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for dev in devices %}
          <tr>
            <!-- Status indicator -->
            <td>
              {% if dev.status == 'critical' %}
                {% set status = 'critical' %}
                {% set color = 'danger' %}
                {% include "partials/_status_badge.html" %}
              {% elif dev.status == 'warning' %}
                {% set status = 'warning' %}
                {% set color = 'warning' %}
                {% set text_dark = true %}
                {% include "partials/_status_badge.html" %}
                {% set text_dark = false %}
              {% elif dev.status == 'info' %}
                {% set status = 'info' %}
                {% set color = 'info' %}
                {% set text_dark = true %}
                {% include "partials/_status_badge.html" %}
                {% set text_dark = false %}
              {% else %}
                {% set status = 'ok' %}
                {% set color = 'success' %}
                {% include "partials/_status_badge.html" %}
              {% endif %}
              {% set color = none %}
            </td>

            <td class="fw-semibold">{{ dev.device_id }}</td>
            <td>{{ dev.customer_id }}</td>
            <td>
              {% if dev.vendor | lower == 'mikrotik' %}
                <i class="bi bi-cpu me-1 text-danger"></i>{{ dev.vendor }}
              {% elif dev.vendor | lower == 'cisco' %}
                <i class="bi bi-cpu me-1 text-primary"></i>{{ dev.vendor }}
              {% else %}
                <i class="bi bi-cpu me-1 text-secondary"></i>{{ dev.vendor }}
              {% endif %}
            </td>

            <td class="text-center">
              {% if dev.open_incidents > 0 %}
                <span class="badge bg-danger rounded-pill">{{ dev.open_incidents }}</span>
              {% else %}
                <span class="text-muted">0</span>
              {% endif %}
            </td>

            <td>
              {% if dev.worst_severity and dev.worst_severity != '—' %}
                {% set severity = dev.worst_severity %}
                {% include "partials/_severity_badge.html" %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>

            <td class="text-muted small">
              {{ dev.last_seen if dev.last_seen else '—' }}
            </td>

            <td>
              <a
                href="{{ url_for('incidents.list_incidents') }}?device_id={{ dev.device_id }}"
                class="btn btn-sm btn-outline-secondary"
                title="Ver incidentes deste dispositivo"
              >
                <i class="bi bi-list-ul"></i>
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
