{% extends "base.html" %}

{% block title %}Overview — SentinelNet{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <h1 class="h4 mb-0">
    <i class="bi bi-speedometer2 me-2 text-warning"></i>Visão Geral do Ambiente
  </h1>
  <div class="d-flex align-items-center gap-3">
    <span id="stream-status" class="badge bg-secondary">
      <i id="stream-status-icon" class="bi bi-circle-fill me-1 sn-dot-icon"></i>conectando...
    </span>
    <div class="d-flex align-items-center gap-1 small text-muted">
      <label for="interval-select" class="mb-0">Intervalo:</label>
      <select id="interval-select" class="form-select form-select-sm sn-w-auto">
        <option value="10">10s</option>
        <option value="30" selected>30s</option>
        <option value="60">1min</option>
        <option value="300">5min</option>
      </select>
    </div>
    <span id="last-updated" class="small text-muted">--:--:--</span>
  </div>
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">

  <div class="col-sm-6 col-xl-3">
    <a href="{{ url_for('devices.list_devices') }}" class="card-link">
      <div class="card border-0 shadow-sm h-100 card-clickable">
        <div class="card-body">
          <p class="text-muted small mb-1"><i class="bi bi-router me-1"></i>Dispositivos</p>
          <h2 id="kpi-devices-total" class="fw-bold text-dark">{{ overview.devices.total }}</h2>
          <div class="d-flex gap-3 mt-2 small flex-wrap">
            <span class="text-success">
              <i class="bi bi-check-circle-fill me-1"></i><span id="kpi-devices-healthy">{{ overview.devices.healthy }}</span> saudaveis
            </span>
            <span class="text-warning">
              <i class="bi bi-exclamation-triangle-fill me-1"></i><span id="kpi-devices-warning">{{ overview.devices.warning }}</span> warning
            </span>
            <span class="text-danger">
              <i class="bi bi-x-circle-fill me-1"></i><span id="kpi-devices-incident">{{ overview.devices.with_incident }}</span> c/ incidente
            </span>
          </div>
        </div>
      </div>
    </a>
  </div>

  <div class="col-sm-6 col-xl-3">
    <a href="{{ url_for('incidents.list_incidents', status='novo') }}" class="card-link">
      <div class="card border-0 shadow-sm h-100 card-clickable">
        <div class="card-body">
          <p class="text-muted small mb-1"><i class="bi bi-exclamation-triangle me-1"></i>Incidentes Abertos</p>
          <h2 id="kpi-inc-open" class="fw-bold text-dark">{{ overview.incidents.open }}</h2>
          <div class="d-flex flex-wrap gap-1 mt-2">
            <span class="badge bg-danger"><span id="kpi-inc-critical">{{ overview.incidents.critical }}</span> CRITICAL</span>
            <span class="badge bg-warning text-dark"><span id="kpi-inc-high">{{ overview.incidents.high }}</span> HIGH</span>
            <span class="badge bg-info text-dark"><span id="kpi-inc-warning">{{ overview.incidents.warning }}</span> WARNING</span>
            <span class="badge bg-light text-dark border"><span id="kpi-inc-info">{{ overview.incidents.info }}</span> INFO</span>
          </div>
        </div>
      </div>
    </a>
  </div>

  <div class="col-sm-6 col-xl-3">
    <a href="{{ url_for('incidents.list_incidents', status='aprovado') }}" class="card-link">
      <div class="card border-0 shadow-sm h-100 card-clickable">
        <div class="card-body">
          <p class="text-muted small mb-1"><i class="bi bi-wrench me-1"></i>Remediacoes</p>
          <h2 id="kpi-remed-pending" class="fw-bold text-dark">{{ overview.remediation.pending_approval }}</h2>
          <p class="text-muted small mt-2 mb-0">aguardando aprovacao</p>
          <p class="text-success small mb-0">
            <span id="kpi-remed-executed">{{ overview.remediation.executed_today }}</span> executadas hoje
          </p>
        </div>
      </div>
    </a>
  </div>

  <div class="col-sm-6 col-xl-3">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <p class="text-muted small mb-1"><i class="bi bi-clock-history me-1"></i>SLO</p>
        <div class="row text-center mt-2">
          <div class="col-6">
            <p id="kpi-mtta" class="fw-bold fs-5 mb-0 text-primary">
              {{ overview.slo.mtta_minutes if overview.slo.mtta_minutes is not none else 'Sem dados suficientes' }}
            </p>
            <p class="text-muted small mb-0">MTTA (min)</p>
          </div>
          <div class="col-6">
            <p id="kpi-mttr" class="fw-bold fs-5 mb-0 text-primary">
              {{ overview.slo.mttr_minutes if overview.slo.mttr_minutes is not none else 'Sem dados suficientes' }}
            </p>
            <p class="text-muted small mb-0">MTTR (min)</p>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Incidentes Recentes -->
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white fw-semibold d-flex justify-content-between align-items-center">
        <span><i class="bi bi-exclamation-circle me-1 text-danger"></i>Incidentes Recentes</span>
        <a href="{{ url_for('incidents.list_incidents') }}" class="btn btn-sm btn-outline-primary">Ver todos</a>
      </div>
      <div class="card-body p-0">
        <div id="recent-incidents-empty" class="text-center text-muted py-5 {% if overview.recent_incidents %}d-none{% endif %}">
          <i class="bi bi-inbox fs-1 d-block mb-2"></i>
          <p class="mb-0">Nenhum incidente aberto.</p>
        </div>
        <div class="table-responsive {% if not overview.recent_incidents %}d-none{% endif %}" id="recent-incidents-table-wrap">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>#</th><th>Dispositivo</th><th>Cliente</th>
                <th>Severidade</th><th>Categoria</th><th>Detectado em</th><th>Status</th>
              </tr>
            </thead>
            <tbody id="recent-incidents-tbody">
              {% for inc in overview.recent_incidents %}
              <tr>
                <td><a href="{{ url_for('incidents.get_incident', incident_id=inc.id) }}">#{{ inc.id }}</a></td>
                <td>{{ inc.device_id }}</td>
                <td>{{ inc.customer_id }}</td>
                <td>
                  {% set severity = inc.severity %}
                  {% include "partials/_severity_badge.html" %}
                </td>
                <td>{{ inc.category }}</td>
                <td>{{ inc.timestamp }}</td>
                <td>
                  {% set status = inc.status %}
                  {% include "partials/_status_badge.html" %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  window.__SENTINEL_OVERVIEW_ENDPOINTS = {
    stream: "{{ url_for('health.stream') }}",
    api: "{{ url_for('health.api_overview') }}",
    incidentDetailBase: "{{ url_for('incidents.get_incident', incident_id=0) | replace('/0', '') }}"
  };
</script>
<script src="{{ url_for('static', filename='js/overview.js') }}"></script>
{% endblock %}
